<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Round of 16 - World Cup 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="./styles/style.css">
</head>
<body>
    <h1>Round of 16 - World Cup 2026</h1>

    <!-- Navigation Dropdown -->
    <div class="navigation-dropdown">
        <label for="navigation-select">Navigate to:</label>
        <select id="navigation-select" onchange="navigateToPage()">
            <option value="group-stage">Group Stage</option>
            <option value="round-of-16" selected>Round of 16</option>
        </select>
    </div>

    <div class="round-of-16-container">
        <!-- Matches will be dynamically generated here -->
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBxdeTLscpv1RK8W7SabyJJckYiBjLQRvM",
            authDomain: "world-cup-2026-b1fda.firebaseapp.com",
            projectId: "world-cup-2026-b1fda",
            storageBucket: "world-cup-2026-b1fda.firebasestorage.app",
            messagingSenderId: "355932893733",
            appId: "1:355932893733:web:cb338ea08dc12705bf05cc",
            measurementId: "G-6QWWJLC2LM"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Navigation function
        function navigateToPage() {
            const selectedPage = document.getElementById('navigation-select').value;
            if (selectedPage === 'round-of-16') {
                window.location.href = 'round-of-16.html';
            } else if (selectedPage === 'group-stage') {
                window.location.href = 'index.html';
            }
        }

                // Check if the user is logged in
                firebase.auth().onAuthStateChanged(user => {
            if (user) {
                console.log(`User is logged in: ${user.email}`);
            } else {
                console.log('No user is logged in.');
            }
        });

        document.getElementById('navigation-select').addEventListener('change', navigateToPage);

        // Fetch Round of 16 matches from Firestore
        async function fetchRoundOf16Matches() {
            try {
                const doc = await db.collection('roundOf16Teams').doc('matches').get();
                if (!doc.exists) {
                    console.error('No Round of 16 matches found in Firestore.');
                    return [];
                }
                return doc.data().matches || [];
            } catch (error) {
                console.error('Error fetching Round of 16 matches:', error);
                return [];
            }
        }

// Generate Round of 16 Matches
async function generateRoundOf16() {
    const container = document.querySelector('.round-of-16-container');
    container.innerHTML = ''; // Clear any existing content to prevent duplicates

    const matches = await fetchRoundOf16Matches();

    if (matches.length === 0) {
        container.innerHTML = '<p>No matches available for the Round of 16.</p>';
        return;
    }

    matches.forEach((match, index) => {
        const table = document.createElement('table');
        table.classList.add('match-table');
        table.innerHTML = `
            <tr>
                <td class="team-name" data-team="team1" data-match="${match.match}">${match.team1}</td>
                <td class="score-section">
                    <input type="number" class="score-input" placeholder="Score" data-match="${match.match}" data-team="team1" value="${match.team1Score || ''}">
                    <span class="score-divider">-</span>
                    <input type="number" class="score-input" placeholder="Score" data-match="${match.match}" data-team="team2" value="${match.team2Score || ''}">
                </td>
                <td class="team-name" data-team="team2" data-match="${match.match}">${match.team2}</td>
                <td>
                    <button class="submit-button" data-match="${match.match}" data-team1="${match.team1}" data-team2="${match.team2}">Submit</button>
                </td>
            </tr>
        `;
        container.appendChild(table);

        // Highlight the winner if it exists
        if (match.winner) {
            const teamCells = table.querySelectorAll(`td[data-match="${match.match}"]`);
            teamCells.forEach(cell => {
                if (cell.textContent.trim() === match.winner) {
                    cell.classList.add('winner');
                } else {
                    cell.classList.remove('winner');
                }
            });
        }

        // Add Extra Time row if it exists
        if (match.extraTime) {
            const row = table.insertRow();
            row.setAttribute('data-extra-time', match.match);
            row.innerHTML = `
                <td>Extra Time</td>
                <td class="score-section">
                    <input type="number" class="score-input" placeholder="Score" data-extra-time="${match.match}" data-team="team1" value="${match.extraTimeTeam1Score || ''}">
                    <span class="score-divider">-</span>
                    <input type="number" class="score-input" placeholder="Score" data-extra-time="${match.match}" data-team="team2" value="${match.extraTimeTeam2Score || ''}">
                </td>
                <td colspan="2">
                    <button class="submit-extra-time" data-match="${match.match}" data-team1="${match.team1}" data-team2="${match.team2}">Submit Extra Time</button>
                </td>
            `;

            // Add event listener for the "Extra Time" button
            row.querySelector('.submit-extra-time').addEventListener('click', handleExtraTimeSubmission);
        }

        // Add Penalty Shootout row if it exists
        if (match.penaltyShootout) {
            const row = table.insertRow();
            row.setAttribute('data-penalty', match.match);
            row.innerHTML = `
                <td>Penalty Shootout</td>
                <td class="score-section">
                    <input type="number" class="score-input" placeholder="Score" data-penalty="${match.match}" data-team="team1" value="${match.penaltyTeam1Score || ''}">
                    <span class="score-divider">-</span>
                    <input type="number" class="score-input" placeholder="Score" data-penalty="${match.match}" data-team="team2" value="${match.penaltyTeam2Score || ''}">
                </td>
                <td colspan="2">
                    <button class="submit-penalty" data-match="${match.match}" data-team1="${match.team1}" data-team2="${match.team2}">Submit Penalty</button>
                </td>
            `;

            // Add event listener for the "Penalty Shootout" button
            row.querySelector('.submit-penalty').addEventListener('click', handlePenaltySubmission);
        }

        // Add a row break after every 4 tables
        if ((index + 1) % 4 === 0) {
            const rowBreak = document.createElement('div');
            rowBreak.style.clear = 'both';
            container.appendChild(rowBreak);
        }
    });

    // Add event listeners to submit buttons
    const submitButtons = document.querySelectorAll('.submit-button');
    submitButtons.forEach(button => {
        button.addEventListener('click', handleScoreSubmission);
    });
}

async function handleScoreSubmission(event) {
    const button = event.target;
    const match = button.dataset.match;
    const team1 = button.dataset.team1;
    const team2 = button.dataset.team2;

    // Get the input fields for the match
    const scoreInputs = document.querySelectorAll(`input[data-match="${match}"]`);
    const team1Score = parseInt(scoreInputs[0].value, 10);
    const team2Score = parseInt(scoreInputs[1].value, 10);

    // Validate scores
    if (isNaN(team1Score) || isNaN(team2Score)) {
        alert('Please enter valid scores for both teams.');
        return;
    }

    // Determine if the match is a draw
    let winner = null;
    let loser = null;
    if (team1Score > team2Score) {
        winner = team1;
        loser = team2;
    } else if (team2Score > team1Score) {
        winner = team2;
        loser = team1;
    } else {
        // If the match is a draw, add an extra time row if it doesn't already exist
        const extraTimeRow = document.querySelector(`tr[data-extra-time="${match}"]`);
        if (!extraTimeRow) {
            const table = button.closest('table');
            const row = table.insertRow();
            row.setAttribute('data-extra-time', match);
            row.innerHTML = `
                <td>Extra Time</td>
                <td class="score-section">
                    <input type="number" class="score-input" placeholder="Score" data-extra-time="${match}" data-team="team1">
                    <span class="score-divider">-</span>
                    <input type="number" class="score-input" placeholder="Score" data-extra-time="${match}" data-team="team2">
                </td>
                <td colspan="2">
                    <button class="submit-extra-time submit-button" data-match="${match}" data-team1="${team1}" data-team2="${team2}">Submit Extra Time</button>
                </td>
            `;
            row.querySelector('.submit-extra-time').addEventListener('click', handleExtraTimeSubmission);
        }
    }

    // Highlight the winner if there is one
    const teamCells = document.querySelectorAll(`td[data-match="${match}"]`);
    teamCells.forEach(cell => {
        if (winner && cell.textContent.trim() === winner) {
            cell.classList.add('winner');
        } else {
            cell.classList.remove('winner');
        }
    });

    // Save the result to Firestore
    try {
        const roundOf16TeamsDoc = await db.collection('roundOf16Teams').doc('matches').get();
        if (!roundOf16TeamsDoc.exists) {
            console.error('No Round of 16 matches document found in Firestore.');
            return;
        }

        const matches = roundOf16TeamsDoc.data().matches;

        // Update the specific match with the new scores
        const updatedMatches = matches.map(m => {
            if (m.match === match) {
                return {
                    ...m,
                    winner: winner || null,
                    loser: loser || null,
                    team1Score: team1Score,
                    team2Score: team2Score
                };
            }
            return m;
        });

        // Save the updated matches back to Firestore
        await db.collection('roundOf16Teams').doc('matches').update({ matches: updatedMatches });

async function handleScoreSubmission(event) {
    const button = event.target;
    const match = button.dataset.match;
    const team1 = button.dataset.team1;
    const team2 = button.dataset.team2;

    // Get the input fields for the match
    const scoreInputs = document.querySelectorAll(`input[data-match="${match}"]`);
    const team1Score = parseInt(scoreInputs[0].value, 10);
    const team2Score = parseInt(scoreInputs[1].value, 10);

    // Validate scores
    if (isNaN(team1Score) || isNaN(team2Score)) {
        alert('Please enter valid scores for both teams.');
        return;
    }

    // Determine if the match is a draw
    let winner = null;
    let loser = null;
    if (team1Score > team2Score) {
        winner = team1;
        loser = team2;
    } else if (team2Score > team1Score) {
        winner = team2;
        loser = team1;
    } else {
        // If the match is a draw, add an extra time row if it doesn't already exist
        const extraTimeRow = document.querySelector(`tr[data-extra-time="${match}"]`);
        if (!extraTimeRow) {
            const table = button.closest('table');
            const row = table.insertRow();
            row.setAttribute('data-extra-time', match);
            row.innerHTML = `
                <td>Extra Time</td>
                <td class="score-section">
                    <input type="number" class="score-input" placeholder="Score" data-extra-time="${match}" data-team="team1">
                    <span class="score-divider">-</span>
                    <input type="number" class="score-input" placeholder="Score" data-extra-time="${match}" data-team="team2">
                </td>
                <td colspan="2">
                    <button class="submit-extra-time" data-match="${match}" data-team1="${team1}" data-team2="${team2}">Submit Extra Time</button>
                </td>
            `;
            row.querySelector('.submit-extra-time').addEventListener('click', handleExtraTimeSubmission);
        }
        alert('The match is a draw. Please handle extra time.');
        return; // Exit the function after adding the extra time row
    }

    // Highlight the winner if there is one
    const teamCells = document.querySelectorAll(`td[data-match="${match}"]`);
    teamCells.forEach(cell => {
        if (winner && cell.textContent.trim() === winner) {
            cell.classList.add('winner');
        } else {
            cell.classList.remove('winner');
        }
    });

    // Save the result to Firestore
    try {
        const roundOf16TeamsDoc = await db.collection('roundOf16Teams').doc('matches').get();
        if (!roundOf16TeamsDoc.exists) {
            console.error('No Round of 16 matches document found in Firestore.');
            return;
        }

        const matches = roundOf16TeamsDoc.data().matches;

        // Update the specific match with the new scores
        const updatedMatches = matches.map(m => {
            if (m.match === match) {
                return {
                    ...m,
                    winner: winner || null, // Save null if no winner yet
                    loser: loser || null,  // Save null if no loser yet
                    team1Score: team1Score,
                    team2Score: team2Score
                };
            }
            return m;
        });

        // Save the updated matches back to Firestore
        await db.collection('roundOf16Teams').doc('matches').update({ matches: updatedMatches });

        // Show an alert only if the match has a winner
        if (winner) {
            alert(`Result saved: ${winner} wins`);
        }
    } catch (error) {
        console.error('Error saving match result:', error);
        alert('Failed to save the result. Please try again.');
    }
}    } catch (error) {
        console.error('Error saving match result:', error);
        alert('Failed to save the result. Please try again.');
    }
}
        
async function handleExtraTimeSubmission(event) {
    const button = event.target;
    const match = button.dataset.match;
    const team1 = button.dataset.team1;
    const team2 = button.dataset.team2;

    // Get the input fields for Extra Time
    const scoreInputs = document.querySelectorAll(`input[data-extra-time="${match}"]`);
    const team1Score = parseInt(scoreInputs[0].value, 10);
    const team2Score = parseInt(scoreInputs[1].value, 10);

    // Validate scores
    if (isNaN(team1Score) || isNaN(team2Score)) {
        alert('Please enter valid scores for both teams.');
        return;
    }

    // Determine if Extra Time is still a draw
    let winner = null;
    let loser = null;
    if (team1Score > team2Score) {
        winner = team1;
        loser = team2;
    } else if (team2Score > team1Score) {
        winner = team2;
        loser = team1;
    }

    // Highlight the winner if there is one
    const teamCells = document.querySelectorAll(`td[data-match="${match}"]`);
    teamCells.forEach(cell => {
        if (winner && cell.textContent.trim() === winner) {
            cell.classList.add('winner');
        } else {
            cell.classList.remove('winner');
        }
    });

    // Save the result to Firestore
    try {
        const roundOf16TeamsDoc = await db.collection('roundOf16Teams').doc('matches').get();
        if (!roundOf16TeamsDoc.exists) {
            console.error('No Round of 16 matches document found in Firestore.');
            return;
        }

        const matches = roundOf16TeamsDoc.data().matches;

        // Update the specific match with extra time data
        const updatedMatches = matches.map(m => {
            if (m.match === match) {
                return {
                    ...m,
                    winner: winner || null,
                    loser: loser || null,
                    extraTime: true,
                    extraTimeTeam1Score: team1Score,
                    extraTimeTeam2Score: team2Score
                };
            }
            return m;
        });

        // Save the updated matches back to Firestore
        await db.collection('roundOf16Teams').doc('matches').update({ matches: updatedMatches });

        if (!winner) {
            // If still a draw, add a penalty shootout row
            const penaltyRow = document.querySelector(`tr[data-penalty="${match}"]`);
            if (!penaltyRow) {
                const table = button.closest('table');
                const row = table.insertRow();
                row.setAttribute('data-penalty', match);
                row.innerHTML = `
                    <td>Penalty Shootout</td>
                    <td class="score-section">
                        <input type="number" class="score-input" placeholder="Score" data-penalty="${match}" data-team="team1">
                        <span class="score-divider">-</span>
                        <input type="number" class="score-input" placeholder="Score" data-penalty="${match}" data-team="team2">
                    </td>
                    <td colspan="2">
                        <button class="submit-penalty submit-button" data-match="${match}" data-team1="${team1}" data-team2="${team2}">Submit Penalty</button>
                    </td>
                `;
                row.querySelector('.submit-penalty').addEventListener('click', handlePenaltySubmission);
            }
        } else {
            alert(`Result saved: ${winner} wins in Extra Time against ${loser}`);
        }
    } catch (error) {
        console.error('Error saving extra time result:', error);
        alert('Failed to save the result. Please try again.');
    }
}
        
async function handlePenaltySubmission(event) {
    const button = event.target;
    const match = button.dataset.match;
    const team1 = button.dataset.team1;
    const team2 = button.dataset.team2;

    // Get the input fields for Penalty Shootout
    const scoreInputs = document.querySelectorAll(`input[data-penalty="${match}"]`);
    const team1Score = parseInt(scoreInputs[0].value, 10);
    const team2Score = parseInt(scoreInputs[1].value, 10);

    // Validate scores
    if (isNaN(team1Score) || isNaN(team2Score)) {
        alert('Please enter valid scores for both teams.');
        return;
    }

    // Determine the winner and loser
    let winner, loser;
    if (team1Score > team2Score) {
        winner = team1;
        loser = team2;
    } else if (team2Score > team1Score) {
        winner = team2;
        loser = team1;
    }

    // Highlight the winner
    const teamCells = document.querySelectorAll(`td[data-match="${match}"]`);
    teamCells.forEach(cell => {
        if (cell.textContent.trim() === winner) {
            cell.classList.add('winner');
        } else {
            cell.classList.remove('winner');
        }
    });

    // Save the result to Firestore
    try {
        const roundOf16TeamsDoc = await db.collection('roundOf16Teams').doc('matches').get();
        const matches = roundOf16TeamsDoc.data().matches.map(m => {
            if (m.match === match) {
                // Merge the new penalty shootout data with the existing match data
                return {
                    ...m,
                    winner,
                    loser,
                    penaltyShootout: true,
                    penaltyTeam1Score: team1Score,
                    penaltyTeam2Score: team2Score
                };
            }
            return m;
        });
        await db.collection('roundOf16Teams').doc('matches').update({ matches });

    } catch (error) {
        console.error('Error saving match result:', error);
        alert('Failed to save the result. Please try again.');
    }
}

        // Generate matches on page load
        generateRoundOf16();
    </script>
</body>
</html>